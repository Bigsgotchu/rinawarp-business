name: Electron Version Guards

on:
  pull_request:
    paths:
      - 'package.json'
      - 'apps/terminal-pro/desktop/package.json'
      - '.github/workflows/_guards.yml'
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'apps/terminal-pro/desktop/package.json'

jobs:
  assert-electron-pinned:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify Node.js version compatibility
        run: |
          NODE_VERSION=$(node --version)
          echo "üîç Node version: $NODE_VERSION"
          # Electron 20.x is compatible with Node 18+ but we use Node 20 LTS for consistency
          if [[ $NODE_VERSION =~ ^v20\. ]]; then
            echo "‚úÖ Node 20.x detected - compatible with Electron 20.3.12 headers"
          else
            echo "‚ö†Ô∏è  Node version $NODE_VERSION detected - ensure compatibility with Electron 20.3.12"
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Assert Electron pinned
        run: |
          EXPECT=20.3.12
          ACTUAL=$(node -p "require('electron/package.json').version")
          [ "$ACTUAL" = "$EXPECT" ] || (echo "Electron version mismatch: $ACTUAL != $EXPECT" && exit 1)
          echo "‚úÖ Electron version is correctly pinned to $EXPECT"

      - name: Verify ABI compatibility
        run: |
          echo "üîç Checking ABI compatibility..."
          cd apps/terminal-pro/desktop
          ABI_OUTPUT=$(pnpm exec node -e "console.log(process.versions.modules)")
          echo "ABI modules: $ABI_OUTPUT"
          if [ "$ABI_OUTPUT" = "107" ]; then
            echo "‚úÖ ABI 107 detected - compatible with Electron 20.3.12"
          else
            echo "‚ùå ABI mismatch detected: $ABI_OUTPUT (expected 107)"
            exit 1
          fi

  pty-smoke-test:
    runs-on: ubuntu-latest
    needs: assert-electron-pinned
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install desktop dependencies
        run: |
          cd apps/terminal-pro/desktop
          pnpm install --frozen-lockfile

      - name: Canary PTY rebuild test
        run: |
          echo "üî® Testing native module rebuild on Linux..."
          cd apps/terminal-pro/desktop
          # Force rebuild node-pty to catch ABI issues early
          pnpm rebuild
          echo "‚úÖ PTY rebuild successful"

      - name: PTY smoke test
        run: |
          echo "üß™ Running PTY functionality smoke test..."
          cd apps/terminal-pro/desktop
          # Create a simple PTY test that doesn't require full app startup
          node -e "
            const pty = require('node-pty');
            console.log('‚úÖ PTY module loads successfully');
            console.log('‚úÖ ABI compatibility confirmed');
          "
          echo "‚úÖ PTY smoke test passed"

  updater-smoke-test:
    runs-on: ubuntu-latest
    needs: assert-electron-pinned
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Verify update feed configuration
        run: |
          echo "üîç Checking updater feed configuration..."
          # Verify the desktop app points to the correct update URL
          cd apps/terminal-pro/desktop
          FEED_URL=$(node -e "
            const pkg = require('./package.json');
            console.log(pkg.build.publish[0].url);
          ")
          echo "üì° Update feed URL: $FEED_URL"

          if [[ "$FEED_URL" == *"rinawarp.dev/stable"* ]]; then
            echo "‚úÖ Update feed URL configured correctly"
          else
            echo "‚ö†Ô∏è  Unexpected update feed URL: $FEED_URL"
          fi

      - name: Smoke test update feed
        run: |
          echo "üß™ Testing update feed accessibility..."
          # Test the update feed endpoint (replace with actual URL)
          FEED_URL="https://updates.rinawarp.dev/stable/latest.yml"

          response=$(curl -s -o /dev/null -w "%{http_code}" "$FEED_URL" || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Update feed is accessible"
            
            # Check if feed references correct Electron version
            feed_content=$(curl -s "$FEED_URL")
            if echo "$feed_content" | grep -q "20.3.12"; then
              echo "‚úÖ Update feed references correct Electron version (20.3.12)"
            else
              echo "‚ö†Ô∏è  Update feed may not reference Electron 20.3.12"
              echo "Feed content preview:"
              echo "$feed_content" | head -10
            fi
          else
            echo "‚ö†Ô∏è  Update feed returned HTTP $response (may be expected in dev)"
          fi

  builder-stack-lockfile-guard:
    runs-on: ubuntu-latest
    needs: assert-electron-pinned
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Builder stack lockfile diff guard
        run: |
          echo "üîç Validating builder stack lockfile consistency..."

          # Expected versions from Renovate group pin
          EXPECTED_BUILDER_VERSION="26.0.12"

          # Extract actual versions from pnpm-lock.yaml
          ACTUAL_BUILDER_VERSION=$(grep -A 5 '"electron-builder"' pnpm-lock.yaml | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/' | cut -d'.' -f1-3)
          ACTUAL_SQUIRREL_VERSION=$(grep -A 5 '"electron-builder-squirrel-windows"' pnpm-lock.yaml | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/' | cut -d'.' -f1-3)
          ACTUAL_APP_BUILDER_VERSION=$(grep -A 5 '"app-builder-lib"' pnpm-lock.yaml | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/' | cut -d'.' -f1-3)
          ACTUAL_DMG_VERSION=$(grep -A 5 '"dmg-builder"' pnpm-lock.yaml | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/' | cut -d'.' -f1-3)

          echo "üì¶ Expected builder stack version: $EXPECTED_BUILDER_VERSION"
          echo "üì¶ Actual versions found:"
          echo "   - electron-builder: $ACTUAL_BUILDER_VERSION"
          echo "   - electron-builder-squirrel-windows: $ACTUAL_SQUIRREL_VERSION"
          echo "   - app-builder-lib: $ACTUAL_APP_BUILDER_VERSION"
          echo "   - dmg-builder: $ACTUAL_DMG_VERSION"

          # Check if all versions match expected
          if [[ "$ACTUAL_BUILDER_VERSION" == "$EXPECTED_BUILDER_VERSION" && \
                "$ACTUAL_SQUIRREL_VERSION" == "$EXPECTED_BUILDER_VERSION" && \
                "$ACTUAL_APP_BUILDER_VERSION" == "$EXPECTED_BUILDER_VERSION" && \
                "$ACTUAL_DMG_VERSION" == "$EXPECTED_BUILDER_VERSION" ]]; then
            echo "‚úÖ Builder stack versions are consistent with Renovate group pin"
          else
            echo "‚ùå Builder stack version drift detected!"
            echo "Expected all packages to be at $EXPECTED_BUILDER_VERSION"
            echo "This may indicate Renovate hasn't updated the lockfile or manual overrides are needed"
            exit 1
          fi
