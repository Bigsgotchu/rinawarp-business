name: ðŸ”¨ Build Cross-Platform Installers

on:
  push:
    branches: [ main, master ]
    paths:
      - 'apps/terminal-pro/desktop/**'
      - '.github/workflows/build-installers.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'apps/terminal-pro/desktop/**'

jobs:
  build-linux:
    name: ðŸ§ Build Linux Installers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ”§ Install Dependencies
        working-directory: apps/terminal-pro/desktop
        run: npm ci
        
      - name: ðŸ§± Build Linux Installers
        working-directory: apps/terminal-pro/desktop
        run: |
          npm run build:linux
          
      - name: ðŸ“ Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            apps/terminal-pro/desktop/dist/*.AppImage
            apps/terminal-pro/desktop/dist/*.deb
            apps/terminal-pro/desktop/dist/*.rpm

  build-windows:
    name: ðŸªŸ Build Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ”§ Install Dependencies
        working-directory: apps/terminal-pro/desktop
        run: npm ci
        
      - name: ðŸ§± Build Windows Installer
        working-directory: apps/terminal-pro/desktop
        run: |
          npm run build:win
        env:
          # Windows Code Signing (set in repository secrets)
          CSC_LINK: ${{ secrets.WINDOWS_CERTIFICATE_PFX }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
          
      - name: ðŸ“ Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            apps/terminal-pro/desktop/dist/*.exe
            apps/terminal-pro/desktop/dist/*.msi

  build-mac:
    name: ðŸŽ Build macOS Installer
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ”§ Install Dependencies
        working-directory: apps/terminal-pro/desktop
        run: npm ci
        
      - name: ðŸŽ macOS Notarization Setup
        run: |
          # Install Xcode command line tools
          xcode-select --install
          # Set up notarization credentials
          echo "${{ secrets.MACOS_NOTARIZATION_PASSWORD }}" | base64 --decode > certificate.p12
        env:
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          
      - name: ðŸ§± Build macOS Installer
        working-directory: apps/terminal-pro/desktop
        run: |
          npm run build:mac
        env:
          # Apple ID for notarization
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          # Developer certificate
          CSC_NAME: "Developer ID Application: RinaWarp (TEAM_ID)"
          CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          
      - name: ðŸŽ Notarize macOS App
        working-directory: apps/terminal-pro/desktop
        run: |
          # Wait for build completion
          sleep 30
          # Find the DMG file
          DMG_FILE=$(ls dist/*.dmg | head -1)
          if [ ! -z "$DMG_FILE" ]; then
            # Submit for notarization
            xcrun notarytool submit "$DMG_FILE" \
              --apple-id "${{ secrets.APPLE_ID }}" \
              --password "${{ secrets.APPLE_ID_PASSWORD }}" \
              --team-id "${{ secrets.APPLE_TEAM_ID }}" \
              --wait
            # Staple the notarization
            xcrun stapler staple "$DMG_FILE"
          fi
          
      - name: ðŸ“ Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: |
            apps/terminal-pro/desktop/dist/*.dmg
            apps/terminal-pro/desktop/dist/*.app

  release:
    name: ðŸš€ Create Release
    needs: [build-linux, build-windows, build-mac]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: installers/
          
      - name: ðŸ“ Organize Installer Files
        run: |
          mkdir -p release
          # Copy Linux installers
          cp linux-installers/* release/ 2>/dev/null || true
          # Copy Windows installers
          cp windows-installers/* release/ 2>/dev/null || true
          # Copy macOS installers
          cp macos-installers/* release/ 2>/dev/null || true
          ls -la release/
          
      - name: ðŸ“ Generate Release Notes
        run: |
          cat > release-notes.md << 'EOF'
          # ðŸŽ‰ RinaWarp Terminal Pro - Cross-Platform Release
          
          ## ðŸ“¦ Available Installers
          
          ### ðŸ§ Linux
          - **AppImage**: Portable, no installation required
          - **DEB Package**: For Debian/Ubuntu systems
          
          ### ðŸªŸ Windows  
          - **NSIS Installer**: Windows 10/11 compatible
          
          ### ðŸŽ macOS
          - **DMG Image**: macOS 10.14+ compatible
          - **Notarized**: Passes Apple Gatekeeper
          
          ## ðŸš€ Installation
          
          Choose your platform and installer above to download and install RinaWarp Terminal Pro!
          
          Built automatically on: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          EOF
          
      - name: ðŸŽ¯ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release-notes.md
          tag_name: v1.0.0
          name: "RinaWarp Terminal Pro v1.0.0"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ”— Update Download Links
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“Š Installers available for all platforms"
          echo "ðŸ”— Download from GitHub Releases"
          echo "ðŸŒ Update website download links to point to new release"