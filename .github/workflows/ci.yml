name: ci
on:
  pull_request:
  push:
    branches: [main]
permissions:
  contents: read
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - name: Setup Corepack
        run: |
          corepack enable
          corepack prepare pnpm@9.0.0 --activate
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Quality gates
      - name: Quality gates
        run: pnpm quality:check
      - name: Electron preload smoke test (dev)
        run: pnpm smoke:preload
      - name: Electron preload smoke test (packaged)
        run: |
          if [ -d "release" ] || [ -d "dist" ]; then
            pnpm smoke:preload:packaged
          else
            echo "Skipping packaged preload test - no build artifacts found"
          fi
      - name: Type check all workspaces
        run: pnpm -r run typecheck || true
      - name: Run tests
        run: pnpm vitest -- --run
      - name: Sentry ping (if configured)
        run: pnpm sentry:ping
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_ENV: ci
      - name: Healthcheck (artifact)
        run: pnpm healthcheck:ci
      - uses: actions/upload-artifact@v4
        with:
          name: healthcheck
          path: .debug/healthcheck.json

      # Cloudflare Pages release guard for production only when pushing to main
      - name: Release guard (Cloudflare Pages)
        run: pnpm release:guard --env production
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

      # Preview deployments on PRs
      - name: Deploy preview to Cloudflare Pages
        if: github.event_name == 'pull_request'
        id: deploy_preview
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_BRANCH: ${{ github.head_ref }}
          CF_ENV: preview
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.head_ref }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Deploying preview for branch: $CF_BRANCH"
          pnpm pages:deploy:preview

      # Wait for Cloudflare Pages deploy (export URL) - Updated step
      - name: Wait for Cloudflare Pages deploy (export URL)
        if: github.event_name == 'pull_request'
        id: pages_wait
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: pnpm pages:wait

      # Ping deployed preview
      - name: Ping deployed preview
        if: github.event_name == 'pull_request'
        env:
          PAGES_URL: ${{ steps.pages_wait.outputs.PAGES_URL }}
        run: pnpm pages:ping

      # Bundle size scan
      - name: Bundle size scan
        if: github.event_name == 'pull_request'
        env:
          BUILD_DIR: apps/website/dist-website
        run: pnpm size:scan

      # Fetch size baseline (latest main)
      - name: Fetch size baseline (latest main)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm size:baseline:fetch

      # Bundle size gate
      - name: Bundle size gate
        if: github.event_name == 'pull_request'
        env:
          SIZE_BASELINE_JSON: ".debug/size-baseline.json"
          SIZE_TOTAL_MAX_INCREASE_PCT: "10"
          SIZE_LARGEST_FILE_MAX_KB: "1024"
        run: pnpm size:gate

      # Lighthouse CI
      - name: Lighthouse CI
        if: github.event_name == 'pull_request'
        env:
          PAGES_URL: ${{ steps.pages_wait.outputs.PAGES_URL }}
        run: pnpm lighthouse:run && pnpm lighthouse:assert

      # PR comment (preview URL + size + Lighthouse)
      - name: PR comment (preview URL + size + Lighthouse)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm pages:pr:comment

      # Production deploy on main
      - name: Deploy production to Cloudflare Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_BRANCH: main
          CF_ENV: production
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: main
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Deploying to production"
          pnpm pages:deploy:prod

      # Wait for Cloudflare Pages production deploy (export URL)
      - name: Wait for Cloudflare Pages production deploy
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: pages_wait_prod
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: pnpm pages:wait

      # Ping production
      - name: Ping production
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          PAGES_URL: ${{ steps.pages_wait_prod.outputs.PAGES_URL }}
        run: pnpm pages:ping

      # Bundle size scan (baseline) for main branch
      - name: Bundle size scan (baseline)
        if: github.ref == 'refs/heads/main'
        run: pnpm size:scan
        env:
          BUILD_DIR: apps/website/dist-website

      # Lighthouse CI (prod)
      - name: Lighthouse CI (prod)
        if: github.ref == 'refs/heads/main'
        env:
          PAGES_URL: ${{ steps.pages_wait_prod.outputs.PAGES_URL }}
        run: pnpm lighthouse:run && pnpm lighthouse:assert

      # Slack notify (prod)
      - name: Slack notify (prod)
        if: github.ref == 'refs/heads/main' && success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: pnpm pages:slack

      # Upload size baseline artifact from main branch
      - name: Upload size baseline artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: size-baseline
          path: .debug/size.json