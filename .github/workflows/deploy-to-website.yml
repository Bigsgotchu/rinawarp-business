# Build, Release, and Deploy RinaWarp Terminal Pro to Cloudflare R2
#
# This workflow:
# 1. Builds the application for all platforms (Linux, macOS, Windows)
# 2. Creates a GitHub Release with versioned artifacts
# 3. Deploys artifacts to Cloudflare R2 bucket (rinawarp-downloads)
# 4. Generates SHA256 checksums for security
#
# Triggered by:
# - Git tag pushes (e.g., v1.0.2)
# - Manual dispatch from GitHub Actions UI
#
# Requirements:
# - GitHub Secrets:
#   - R2_ACCOUNT_ID: Cloudflare account ID
#   - R2_ACCESS_KEY_ID: R2 access key ID
#   - R2_SECRET_ACCESS_KEY: R2 secret access key
#   - R2_BUCKET_NAME: R2 bucket name (rinawarp-downloads)
#   - R2_ENDPOINT: R2 endpoint URL
#   - R2_PREFIX: Prefix for terminal-pro files (terminal-pro/)
name: Build, Release, and Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (skip deployment)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Pre-checkout hardening (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git --version
          git config --global core.longpaths true
          git config --global core.protectNTFS true
          git config --global core.protectHFS true
          git config --global core.autocrlf false
          git config --global fetch.prune true
          git config --global advice.detachedHead false
          git config --global gc.auto 0
          git config --global http.postBuffer 524288000
          git config --global pack.windowMemory 256m
          git config --global pack.packSizeLimit 256m
          git config --global pack.threads 1
          git config --global index.threads 1
          git config --global status.aheadBehind false
          git config --global protocol.version 2
          git config --global safe.directory "*"
          git config --global --list

      - name: Pre-checkout hardening (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          git --version
          git config --global core.longpaths true || true
          git config --global core.protectNTFS true || true
          git config --global core.protectHFS true || true
          git config --global core.autocrlf false || true
          git config --global fetch.prune true || true
          git config --global advice.detachedHead false || true
          git config --global gc.auto 0 || true
          git config --global protocol.version 2 || true
          git config --global safe.directory "*" || true
          git config --global --list

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Ensure Electron context
        run: node -e "if(process.env.ELECTRON_RUN_AS_NODE){process.exit(1)}"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test || echo "Tests completed (may have failures)"

      - name: Build application
        run: npm run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          WIN_CERT_PATH: ${{ secrets.WIN_CERT_PATH }}
          WIN_CERT_PASSWORD: ${{ secrets.WIN_CERT_PASSWORD }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: dist-terminal-pro/
          retention-days: 1

  create-release:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Pre-checkout hardening
        shell: bash
        run: |
          set -euo pipefail
          git --version
          git config --global core.longpaths true || true
          git config --global core.protectNTFS true || true
          git config --global core.protectHFS true || true
          git config --global core.autocrlf false || true
          git config --global fetch.prune true || true
          git config --global advice.detachedHead false || true
          git config --global gc.auto 0 || true
          git config --global protocol.version 2 || true
          git config --global safe.directory "*" || true
          git config --global --list

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: extract_version
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: RinaWarp Terminal Pro v${{ steps.extract_version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true

  deploy-to-website:
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.event.inputs.dry-run != 'true'
    steps:
      - name: Pre-checkout hardening
        shell: bash
        run: |
          set -euo pipefail
          git --version
          git config --global core.longpaths true || true
          git config --global core.protectNTFS true || true
          git config --global core.protectHFS true || true
          git config --global core.autocrlf false || true
          git config --global fetch.prune true || true
          git config --global advice.detachedHead false || true
          git config --global gc.auto 0 || true
          git config --global protocol.version 2 || true
          git config --global safe.directory "*" || true
          git config --global --list

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-terminal-pro
          pattern: build-artifacts-*
          merge-multiple: true

      - name: Install gh CLI
        uses: cli/gh-action@v2

      - name: Download release assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "Downloading release assets from tag: $TAG"
          gh release download "$TAG" --dir downloaded-assets --pattern "*.AppImage" --pattern "*.deb" --pattern "*.dmg" --pattern "*.exe" --pattern "*.rpm" || echo "No assets found or download failed"

      - name: Prepare deployment directory structure
        run: |
          # Create a temporary directory for organizing files
          mkdir -p deploy-organized

          # Copy downloaded assets to organized structure
          if [ -f "downloaded-assets/RinaWarp-Terminal-Pro-*-x64.AppImage" ]; then
            cp downloaded-assets/RinaWarp-Terminal-Pro-*-x64.AppImage deploy-organized/RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.AppImage
          fi

          if [ -f "downloaded-assets/rinawarp-terminal-pro_*-amd64.deb" ]; then
            cp downloaded-assets/rinawarp-terminal-pro_*-amd64.deb deploy-organized/rinawarp-terminal-pro_${{ needs.create-release.outputs.version }}_amd64.deb
          fi

          if [ -f "downloaded-assets/RinaWarp-Terminal-Pro-*-mac-universal.dmg" ]; then
            cp downloaded-assets/RinaWarp-Terminal-Pro-*-mac-universal.dmg deploy-organized/RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.dmg
          elif [ -f "downloaded-assets/RinaWarp-Terminal-Pro-*-mac-x64.dmg" ]; then
            cp downloaded-assets/RinaWarp-Terminal-Pro-*-mac-x64.dmg deploy-organized/RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.dmg
          fi

          if [ -f "downloaded-assets/RinaWarp-Terminal-Pro-*-win-x64.exe" ]; then
            cp downloaded-assets/RinaWarp-Terminal-Pro-*-win-x64.exe deploy-organized/RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.exe
          fi

      - name: Generate SHA256 checksums
        run: |
          cd deploy-organized
          find . -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.dmg" -o -name "*.exe" \) -exec shasum -a 256 {} \; > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Install AWS CLI for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto
          role-duration-seconds: 3600
          role-skip-assumption-role-alternate: true

      - name: Configure AWS CLI for R2 endpoint
        run: |
          aws configure set endpoint_url https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set region auto

      - name: Upload artifacts to Cloudflare R2
        run: |
          # Set the R2 prefix for terminal-pro downloads
          PREFIX="${{ secrets.R2_PREFIX || 'terminal-pro/' }}"

          # Upload each file with proper content type
          cd deploy-organized

          # Upload AppImage
          if [ -f "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.AppImage" ]; then
            aws s3 cp "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.AppImage" "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.AppImage" \
              --acl public-read \
              --content-type "application/x-executable" \
              --metadata "x-rinawarp-version=${{ needs.create-release.outputs.version }}"
          fi

          # Upload DEB
          if [ -f "rinawarp-terminal-pro_${{ needs.create-release.outputs.version }}_amd64.deb" ]; then
            aws s3 cp "rinawarp-terminal-pro_${{ needs.create-release.outputs.version }}_amd64.deb" "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}rinawarp-terminal-pro_${{ needs.create-release.outputs.version }}_amd64.deb" \
              --acl public-read \
              --content-type "application/vnd.debian.binary-package" \
              --metadata "x-rinawarp-version=${{ needs.create-release.outputs.version }}"
          fi

          # Upload DMG
          if [ -f "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.dmg" ]; then
            aws s3 cp "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.dmg" "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.dmg" \
              --acl public-read \
              --content-type "application/x-apple-diskimage" \
              --metadata "x-rinawarp-version=${{ needs.create-release.outputs.version }}"
          fi

          # Upload EXE
          if [ -f "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.exe" ]; then
            aws s3 cp "RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.exe" "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}RinaWarp_Terminal_Pro-v${{ needs.create-release.outputs.version }}.exe" \
              --acl public-read \
              --content-type "application/vnd.microsoft.portable-executable" \
              --metadata "x-rinawarp-version=${{ needs.create-release.outputs.version }}"
          fi

          # Upload SHA256SUMS
          aws s3 cp "SHA256SUMS.txt" "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}SHA256SUMS.txt" \
            --acl public-read \
            --content-type "text/plain" \
            --metadata "x-rinawarp-version=${{ needs.create-release.outputs.version }}"

      - name: Verify R2 uploads
        run: |
          PREFIX="${{ secrets.R2_PREFIX || 'terminal-pro/' }}"

          echo "Verifying uploads to R2 bucket: ${{ secrets.R2_BUCKET_NAME }}"
          echo "Prefix: ${PREFIX}"
          echo "Version: v${{ needs.create-release.outputs.version }}"

          # List uploaded files
          aws s3 ls "s3://${{ secrets.R2_BUCKET_NAME }}/${PREFIX}" --recursive

      - name: Verify deployment
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Artifacts uploaded to Cloudflare R2 bucket: ${{ secrets.R2_BUCKET_NAME }}"
          echo "Prefix: ${{ secrets.R2_PREFIX || 'terminal-pro/' }}"
          echo "Version: v${{ needs.create-release.outputs.version }}"

  deploy-dry-run:
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event.inputs.dry-run == 'true'
    steps:
      - name: Dry run - skipping deployment
        run: |
          echo "✅ Dry run mode enabled"
          echo "Version: v${{ needs.create-release.outputs.version }}"
          echo "Build completed successfully, but deployment was skipped as requested"

  alias-assets:
    needs: deploy-to-website
    runs-on: ubuntu-latest
    steps:
      - name: Pre-checkout hardening
        shell: bash
        run: |
          set -euo pipefail
          git --version
          git config --global core.longpaths true || true
          git config --global core.protectNTFS true || true
          git config --global core.protectHFS true || true
          git config --global core.autocrlf false || true
          git config --global fetch.prune true || true
          git config --global advice.detachedHead false || true
          git config --global gc.auto 0 || true
          git config --global protocol.version 2 || true
          git config --global safe.directory "*" || true
          git config --global --list

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install gh
        uses: cli/gh-action@v2

      - name: Download release assets
        run: echo "Assets already in Release by electron-builder"

      - name: Prepare aliases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Query assets list
          ASSETS_JSON=$(gh release view "$TAG" --json assets)
          get_url() { echo "$ASSETS_JSON" | node -e "const j=JSON.parse(require('fs').readFileSync(0,'utf8')); const f=j.assets.find(a=>a.name.includes(process.argv[1])); if(f) console.log(f.name);" "$1"; }

          # Map real filenames -> alias filenames
          MAC_ARM_NAME=$(get_url "mac-arm64.dmg") || true
          MAC_X64_NAME=$(get_url "mac-x64.dmg") || true
          MAC_UNIVERSAL_NAME=$(get_url "mac-universal.dmg") || true
          WIN_NAME=$(get_url "win-x64.exe") || true
          APPIMG_NAME=$(get_url "linux-x86_64.AppImage") || true
          DEB_NAME=$(get_url "amd64.deb") || true
          RPM_NAME=$(get_url ".x86_64.rpm") || true

          # Download and upload with aliases
          download_and_upload () {
            SRC="$1"; ALIAS="$2";
            if [ -n "$SRC" ]; then
              echo "Aliasing $SRC -> $ALIAS"
              gh release download "$TAG" -p "$SRC"
              cp "$SRC" "$ALIAS"
              gh release upload "$TAG" "$ALIAS" --clobber
            fi
          }

          # Prefer universal DMG if present
          if [ -n "$MAC_UNIVERSAL_NAME" ]; then
            download_and_upload "$MAC_UNIVERSAL_NAME" "RinaWarp-mac-universal-latest.dmg"
          else
            download_and_upload "$MAC_ARM_NAME" "RinaWarp-mac-arm64-latest.dmg"
            download_and_upload "$MAC_X64_NAME" "RinaWarp-mac-x64-latest.dmg"
          fi
          download_and_upload "$WIN_NAME" "RinaWarp-win-x64-latest.exe"
          download_and_upload "$APPIMG_NAME" "RinaWarp-linux-x86_64-latest.AppImage"
          download_and_upload "$DEB_NAME" "RinaWarp-linux-amd64-latest.deb"
          download_and_upload "$RPM_NAME" "RinaWarp-linux-x86_64-latest.rpm"

      - name: Generate SHA256 checksums & attach
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          TMPDIR=$(mktemp -d); cd "$TMPDIR"
          gh release download "$TAG" -p "RinaWarp-*-latest.*"
          shasum -a 256 RinaWarp-*-latest.* > SHA256SUMS.txt
          gh release upload "$TAG" SHA256SUMS.txt --clobber
