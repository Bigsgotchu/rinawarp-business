name: Build & Deploy Docs to Netlify

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]  # also builds when you create a release tag like v2.0.0
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.11"
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_DOCS_SITE_ID }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set release version (tag or dev)
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "RELEASE_VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
            echo "BUILD_TYPE=release" >> $GITHUB_ENV
          else
            echo "RELEASE_VERSION=dev-${GITHUB_SHA::7}" >> $GITHUB_ENV
            echo "BUILD_TYPE=development" >> $GITHUB_ENV
          fi
          echo "Version: $RELEASE_VERSION"
          echo "Type: $BUILD_TYPE"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('mkdocs.yml', '**/*.md') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install MkDocs + Material
        run: |
          pip install mkdocs mkdocs-material mkdocs-git-revision-date-localized-plugin mkdocs-minify-plugin

      - name: Verify MkDocs installation
        run: |
          mkdocs --version
          pip list | grep mkdocs

      - name: Validate mkdocs.yml
        run: |
          mkdocs build --clean --strict

      - name: Build documentation
        run: |
          echo "Building RinaWarp documentation..."
          mkdocs build --clean
          echo "Built docs version: $RELEASE_VERSION"
          echo "Build type: $BUILD_TYPE"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rinawarp-docs-${{ env.RELEASE_VERSION }}
          path: site/
          retention-days: 30

      - name: Deploy to Netlify (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -n "$NETLIFY_SITE_ID" ] && [ -n "$NETLIFY_AUTH_TOKEN" ]; then
            echo "Deploying to production..."
            npm install -g netlify-cli
            netlify deploy \
              --dir=site \
              --site=$NETLIFY_SITE_ID \
              --auth=$NETLIFY_AUTH_TOKEN \
              --prod \
              --message="Deploy docs version $RELEASE_VERSION"
          else
            echo "Netlify credentials not configured. Skipping deployment."
          env:
            NETLIFY_SITE_ID: ${{ secrets.NETLIFY_DOCS_SITE_ID }}
            NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Deploy to Netlify (Preview)
        if: github.event_name == 'pull_request'
        run: |
          if [ -n "$NETLIFY_SITE_ID" ] && [ -n "$NETLIFY_AUTH_TOKEN" ]; then
            echo "Deploying preview for PR..."
            npm install -g netlify-cli
            netlify deploy \
              --dir=site \
              --site=$NETLIFY_SITE_ID \
              --auth=$NETLIFY_AUTH_TOKEN \
              --alias=pr-${{ github.event.number }}-${{ env.RELEASE_VERSION }} \
              --message="Preview docs version $RELEASE_VERSION for PR #${{ github.event.number }}"
          else
            echo "Netlify credentials not configured. Skipping preview deployment."
          env:
            NETLIFY_SITE_ID: ${{ secrets.NETLIFY_DOCS_SITE_ID }}
            NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Notify deployment status
        if: always()
        run: |
          echo "Deployment completed for version: $RELEASE_VERSION"
          echo "Build type: $BUILD_TYPE"
          if [[ "$BUILD_TYPE" == "release" ]]; then
            echo "üéâ Production deployment ready!"
          else
            echo "üìù Development build completed"
          fi