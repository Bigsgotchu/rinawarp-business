# Agent v1 IPC Surface - Locked API Contract

**Status:** v1.0.0 - LOCKED  
**Date:** 2025-12-17  
**Breaking Changes:** None permitted without major version bump

## Overview

This document defines the authoritative IPC (Inter-Process Communication) surface for Agent v1.0. All channels and payloads defined here are stable and constitute the complete external API surface for agent operations.

## Core Principles

- **Security First:** All channels respect contextIsolation: true and CSP requirements
- **Deterministic:** State transitions are predictable and traceable
- **Observable:** Execution correlation IDs enable tracking across all operations
- **Idiomatic:** Follow established Electron IPC patterns

## Agent Lifecycle

```
idle → planning → acting → idle
  ↓      ↓         ↓
error   error     error → idle (soft reset)
```

## IPC Channels (v1.0.0 LOCKED)

### Agent Planning Channel

**Channel:** `agent:v1:plan`  
**Direction:** Renderer → Main  
**Purpose:** Convert user intent into actionable proposals

**Request Payload:**
```typescript
{
  intent: string;           // User's natural language request
  // Internal fields managed by agent-state machine
}
```

**Response Payload:**
```typescript
{
  ok: boolean;
  proposals?: Array<{
    id: string;             // Unique proposal identifier
    title: string;          // Human-readable action title
    description: string;    // Action description
    params?: object;        // Action parameters
  }>;
  reply?: string;           // Natural language response
  error?: string;           // Error message if ok: false
}
```

### Agent Execution Channel

**Channel:** `agent:v1:execute`  
**Direction:** Renderer → Main  
**Purpose:** Execute confirmed user action

**Request Payload:**
```typescript
{
  actionId: string;         // From proposal.id
  params?: object;          // From proposal.params
  executionId: string;      // Generated by agent-state machine
}
```

**Response Payload:**
```typescript
{
  ok: boolean;
  terminal?: string;        // Terminal output (if applicable)
  reply?: string;           // Natural language response
  error?: string;           // Error message if ok: false
}
```

### Agent Status Channel

**Channel:** `agent:get-status`  
**Direction:** Renderer → Main  
**Purpose:** Health check and agent status

**Request Payload:**
```typescript
{}  // Empty object
```

**Response Payload:**
```typescript
{
  healthy: boolean;
  error?: string;           // Error message if unhealthy
  // Additional status fields as needed
}
```

### General Agent Communication

**Channel:** `agent:ask`  
**Direction:** Renderer → Main  
**Purpose:** General-purpose agent communication (Cloudflare Worker integration)

**Request Payload:**
```typescript
{
  // Arbitrary payload structure
  [key: string]: any;
}
```

**Response Payload:**
```typescript
{
  ok: boolean;
  // Arbitrary response structure
  [key: string]: any;
  error?: string;           // Error message if ok: false
}
```

## Terminal Integration Channels

### Terminal Data Channel

**Channel:** `terminal:data`  
**Direction:** Main → Renderer  
**Purpose:** Stream PTY output to conversation UI

**Event Payload:**
```typescript
{
  data: string;             // Raw terminal output
  executionId?: string;     // Correlation ID from agent execution
}
```

### Terminal Exit Channel

**Channel:** `terminal:exit`  
**Direction:** Main → Renderer  
**Purpose:** Notify terminal process termination

**Event Payload:**
```typescript
{
  code?: number;            // Exit code
  signal?: string;          // Signal name (if terminated by signal)
  executionId?: string;     // Correlation ID from agent execution
}
```

### Terminal Creation (Internal)

**Channel:** `terminal:create`  
**Direction:** Renderer → Main  
**Purpose:** Create new terminal instance (internal use)

**Request Payload:**
```typescript
{
  cwd?: string;             // Working directory
  env?: object;             // Environment variables
}
```

## Error Handling

All channels follow consistent error patterns:

- `ok: false` with `error: string` for failures
- Network/transient errors return appropriate HTTP status codes
- Validation errors return clear, actionable messages
- No sensitive information in error messages

## Security Considerations

- All IPC handlers validate input payloads
- contextIsolation: true is enforced
- No dynamic code execution
- CSP-compliant (no inline scripts, no eval)
- Execution correlation IDs prevent confusion between concurrent operations

## State Management

Agent state machine provides:
- Deterministic state transitions
- Execution correlation tracking
- Error recovery with soft reset policy
- Observable state changes for debugging

## Future Compatibility

This API surface is locked for v1.x.x. Future changes will require:

1. **v1.x:** Backward-compatible additions (new optional fields)
2. **v2.0:** Breaking changes with migration path
3. **Deprecation:** 90-day notice for any removed features

## Validation

All payload structures should be validated using TypeScript interfaces defined in this document. Any deviations should be considered breaking changes requiring version bump.

---

**Next Steps for v1.0.0:**
- [x] Lock IPC surface (this document)
- [x] Add execution correlation IDs
- [x] Implement dev panel for debugging
- [x] Add terminal output throttling
- [x] Implement soft reset policy for errors

**Commit Message Template:**
```
feat(agent-v1): CSP-safe modular agent architecture with IPC execution flow

- Add execution correlation IDs for parallel execution tracking
- Lock IPC surface as v1.0.0 complete API contract
- Add developer debug panel for monitoring agent state
- Implement terminal output throttling and soft reset policy
- All channels validated and documented