#!/bin/bash
set -euo pipefail

COMMAND="${1:-help}"
ARG="${2:-}"

show_help() {
cat <<'HELP'
=====================================================
                ðŸ’Ž RINAWARP CLI
=====================================================
Usage:
  rina <command> [option]

Core commands:
  fix                  - Full VSCode + Node + Git repair
  status               - Full system status dashboard
  logs                 - View logs for API, NGINX, system
  backup               - Create full RinaWarp server backup
  nginx <reload|test|fix>
                       - Manage NGINX
  api <restart|stop>   - Manage API service
  services             - Run safe services cleanup
  health               - Check API + Web health
  cert-fix             - Heal certbot + nginx + consolidate certs
  md-fix <file.md>     - Auto-fix markdownlint issues in a file

Examples:
  rina fix
  rina status
  rina nginx test
  rina api restart
  rina cert-fix
  rina md-fix RINAWARP-CLI-COMPLETE-GUIDE.md
=====================================================
HELP
}

do_fix() {
  echo ">>> Running rina-fix global repair..."
  /usr/local/bin/rina-fix || true
}

do_status() {
  echo ">>> RinaWarp Status Dashboard"
  ~/RinaWarp/rina-services-status.sh
}

do_logs() {
  echo ">>> Viewing logs (rinawarp-api + nginx)..."
  sudo journalctl -u rinawarp-api -n 100 --no-pager 2>/dev/null || true
  sudo journalctl -u nginx -n 100 --no-pager 2>/dev/null || true
}

do_backup() {
  echo ">>> Creating full RinaWarp backup..."
  ~/RinaWarp/rina-master-backup.sh
}

do_nginx() {
  local sub="${ARG:-}"
  case "$sub" in
    reload)
      sudo nginx -t && sudo systemctl reload nginx
      echo ">>> NGINX Reloaded."
      ;;
    test)
      sudo nginx -t
      ;;
    fix)
      echo ">>> Running bulletproof nginx repair..."
      ~/RinaWarp/nginx-bulletproof-fix.sh
      ;;
    *)
      echo "Usage: rina nginx <reload|test|fix>"
      ;;
  esac
}

do_api() {
  local sub="${ARG:-}"
  case "$sub" in
    restart)
      sudo systemctl restart rinawarp-api 2>/dev/null || pm2 restart rinawarp-api || pm2 restart all
      echo ">>> API restarted."
      ;;
    stop)
      sudo systemctl stop rinawarp-api 2>/dev/null || true
      echo ">>> API stopped."
      ;;
    *)
      echo "Usage: rina api <restart|stop>"
      ;;
  esac
}

do_services() {
  ~/RinaWarp/rina-services-clean.sh
}

do_health() {
  echo ">>> API Health:"
  curl -I https://api.rinawarptech.com/health || true
  echo ""
  echo ">>> Web Health:"
  curl -I https://rinawarptech.com || true
}

do_cert_fix() {
  echo ">>> Running RinaWarp Cert & NGINX Healer..."
  sudo ~/RinaWarp/rina-cert-fix.sh
}

do_md_fix() {
  local file="${ARG:-}"
  if [ -z "$file" ]; then
    echo "Usage: rina md-fix <file.md>"
    exit 1
  fi
  echo ">>> Fixing markdown file: $file"
  ~/RinaWarp/rina-md-fix.sh "$file"
}

case "$COMMAND" in
  fix)        do_fix ;;
  status)     do_status ;;
  logs)       do_logs ;;
  backup)     do_backup ;;
  nginx)      do_nginx ;;
  api)        do_api ;;
  services)   do_services ;;
  health)     do_health ;;
  cert-fix)   do_cert_fix ;;
  md-fix)     do_md_fix ;;
  help|*)     show_help ;;
esac