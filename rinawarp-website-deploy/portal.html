<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Portal ‚Äì RinaWarp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .tab-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
    }
    .tab {
      padding: 0.5rem 1rem;
      background: var(--bg-subtle);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .tab.active {
      background: var(--bg-active);
      border-color: var(--border-active);
      color: var(--text-active);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-icon {
      font-size: 1.2rem;
      margin-right: 0.5rem;
    }
  </style>
</head>

<body>
<div class="wrapper theme-mermaid">

  <header class="site-header">
    <div class="container">
      <nav class="navbar">
        <div class="nav-left">
          <div class="logo-mark"><span>RW</span></div>
          <div class="brand-text">
            <strong>RINAWARP</strong>
            <span>Portal</span>
          </div>
        </div>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="download.html">Download</a>
          <a href="portal.html" class="active">My Portal</a>
          <button class="btn btn-ghost" style="margin-left:1rem;" onclick="logout()">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="section-header">
        <div class="section-kicker">Dashboard</div>
        <h1 class="section-title">Welcome, <span id="user-name">‚Äî</span></h1>
        <p class="section-description">
          Manage your licenses, devices, and billing in one place.
        </p>
      </div>

      <div id="not-auth" class="hero-card" style="display:none;">
        <p>You are not signed in.</p>
        <a href="login.html" class="btn btn-primary" style="margin-top:0.5rem;">Go to sign in</a>
      </div>

      <div id="portal-content" style="display:none;">

        <!-- Tab Navigation -->
        <div class="tab-container">
          <div class="tab active" onclick="switchTab('profile')">
            <span class="section-icon">üë§</span> Profile
          </div>
          <div class="tab" onclick="switchTab('licenses')">
            <span class="section-icon">üîë</span> Licenses
          </div>
          <div class="tab" onclick="switchTab('devices')">
            <span class="section-icon">üíª</span> Devices
          </div>
          <div class="tab" onclick="switchTab('activity')">
            <span class="section-icon">üõ°Ô∏è</span> Security Activity
          </div>
          <div class="tab" onclick="switchTab('export')">
            <span class="section-icon">üì•</span> Data Export
          </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content active">
          <div class="hero-card">
            <h3><span class="section-icon">üë§</span> Account Information</h3>
            <p><strong>Email:</strong> <span id="user-email"></span></p>
            <p><strong>Member since:</strong> <span id="user-created"></span></p>
            <p><strong>Status:</strong> <span id="user-status">Active</span></p>

            <hr style="margin:1rem 0;opacity:0.3;" />

            <h4>Account Actions</h4>
            <button class="btn btn-ghost" onclick="downloadUserData('json')">üì• Export JSON</button>
            <button class="btn btn-ghost" onclick="downloadUserData('csv')">üì• Export CSV</button>
          </div>
        </div>

        <!-- Licenses Tab -->
        <div id="licenses-tab" class="tab-content">
          <div class="hero-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3><span class="section-icon">üîë</span> Your Licenses</h3>
              <small id="license-count" style="color:var(--text-muted);"></small>
            </div>
            <div id="licenses-list" style="margin-top:0.75rem;display:flex;flex-direction:column;gap:0.75rem;"></div>
          </div>
        </div>

        <!-- Devices Tab -->
        <div id="devices-tab" class="tab-content">
          <div class="hero-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3><span class="section-icon">üíª</span> Your Devices</h3>
              <small id="device-count" style="color:var(--text-muted);"></small>
            </div>
            <div id="devices-list" style="margin-top:0.75rem;display:flex;flex-direction:column;gap:0.75rem;"></div>
          </div>
        </div>

        <!-- Security Activity Tab -->
        <div id="activity-tab" class="tab-content">
          <div class="hero-card">
            <h3><span class="section-icon">üõ°Ô∏è</span> Recent Security Activity</h3>
            <div id="events-list" style="margin-top:0.75rem;display:flex;flex-direction:column;gap:0.5rem;"></div>
          </div>
        </div>

        <!-- Data Export Tab -->
        <div id="export-tab" class="tab-content">
          <div class="hero-card">
            <h3><span class="section-icon">üì•</span> GDPR Data Export</h3>
            <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">
              Download your personal data in compliance with GDPR regulations.
            </p>

            <div style="display:flex;flex-direction:column;gap:0.75rem;">
              <button class="btn btn-primary" onclick="downloadUserData('json')" style="justify-content:center;">
                <span class="section-icon">üì•</span> Download JSON Export
              </button>
              <button class="btn btn-primary" onclick="downloadUserData('csv')" style="justify-content:center;">
                <span class="section-icon">üì•</span> Download CSV Export
              </button>
            </div>

            <hr style="margin:1.5rem 0;opacity:0.3;" />

            <h4>What's Included?</h4>
            <ul style="font-size:0.9rem;color:var(--text-muted);line-height:1.5;">
              <li>üë§ Your account information (email, name, creation date)</li>
              <li>üîë All your licenses and subscription details</li>
              <li>üíª Registered devices and usage information</li>
              <li>üõ°Ô∏è Recent security events and activity logs</li>
              <li>üìÖ Timeline of your account activity</li>
            </ul>
          </div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (res.status === 401) throw new Error("unauthorized");
  if (!res.ok) throw new Error("error");
  return res.json();
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });

  // Show selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');
  event.target.closest('.tab').classList.add('active');
}

async function initPortal() {
  try {
    const profileData = await fetchJSON("/api/user/profile");
    const user = profileData.user;
    document.getElementById("user-name").textContent = user.name || user.email || "RinaWarp user";
    document.getElementById("user-email").textContent = user.email;
    document.getElementById("user-created").textContent =
      new Date(user.created_at || user.createdAt || Date.now()).toLocaleDateString();
    document.getElementById("user-status").textContent = user.status || "Active";

    document.getElementById("not-auth").style.display = "none";
    document.getElementById("portal-content").style.display = "block";

    loadLicenses(profileData.licenses);
    loadDevices(profileData.devices);
    loadSecurityEvents(profileData.recent_activity);
  } catch (err) {
    document.getElementById("not-auth").style.display = "block";
    document.getElementById("portal-content").style.display = "none";
  }
}

async function loadLicenses(licenses) {
  try {
    const list = document.getElementById("licenses-list");
    list.innerHTML = "";
    document.getElementById("license-count").textContent = `${licenses.length} licenses`;

    if (!licenses.length) {
      list.innerHTML = "<p style='color:var(--text-muted);font-size:0.9rem;'>No licenses yet.</p>";
      return;
    }

    licenses.forEach(lic => {
      const div = document.createElement("div");
      div.style.cssText =
        "border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:0.75rem;";
      const created = new Date(lic.created_at || lic.createdAt).toLocaleString();
      const seatsInfo = lic.seats
        ? ` ‚Ä¢ Seats: ${lic.usedSeats || 0}/${lic.seats}`
        : "";
      div.innerHTML = `
        <strong>üîë ${lic.plan || "Terminal Pro"}</strong>
        <span style="font-size:0.8rem;color:var(--text-muted);">(${lic.status})</span><br/>
        <span style="font-size:0.8rem;color:var(--text-muted);">
          Key: ${lic.id}<br/>
          Created: ${created}${seatsInfo}
        </span><br/>
        <button class="btn btn-ghost" style="margin-top:0.4rem;"
                onclick="openBillingPortal('${lic.id}')">
          üí≥ Manage billing
        </button>
      `;
      list.appendChild(div);
    });
  } catch (err) {
    document.getElementById("licenses-list").innerHTML =
      "<p style='color:#ff2d92;font-size:0.9rem;'>Error loading licenses.</p>";
  }
}

async function loadDevices(devices) {
  try {
    const list = document.getElementById("devices-list");
    list.innerHTML = "";
    document.getElementById("device-count").textContent = `${devices.length} devices`;

    if (!devices.length) {
      list.innerHTML = "<p style='color:var(--text-muted);font-size:0.9rem;'>No devices yet.</p>";
      return;
    }

    devices.forEach(d => {
      const div = document.createElement("div");
      div.style.cssText =
        "border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:0.75rem;";
      div.innerHTML = `
        <strong>üíª ${d.device_name || "Unnamed device"}</strong>
        <span style="font-size:0.8rem;color:var(--text-muted);">(${d.os_name || "unknown OS"})</span><br/>
        <span style="font-size:0.8rem;color:var(--text-muted);">
          License: ${d.license_id || "‚Äî"}<br/>
          Last seen: ${d.last_active_at ? new Date(d.last_active_at).toLocaleString() : "‚Äî"}
        </span>
      `;
      list.appendChild(div);
    });
  } catch (err) {
    document.getElementById("devices-list").innerHTML =
      "<p style='color:#ff2d92;font-size:0.9rem;'>Error loading devices.</p>";
  }
}

async function loadSecurityEvents(activity) {
  try {
    const list = document.getElementById("events-list");
    list.innerHTML = "";

    if (!activity.length) {
      list.innerHTML = "<p style='color:var(--text-muted);font-size:0.9rem;'>No recent events.</p>";
      return;
    }

    activity.forEach(e => {
      const div = document.createElement("div");
      div.style.cssText =
        "border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:0.5rem;";
      div.innerHTML = `
        <strong>üõ°Ô∏è ${e.action || "Activity"}</strong><br/>
        <span style="font-size:0.8rem;color:var(--text-muted);">
          ${e.metadata?.description || ""}<br/>
          ${new Date(e.created_at).toLocaleString()} ‚Ä¢ IP: ${e.ip_address || "‚Äî"}
        </span>
      `;
      list.appendChild(div);
    });
  } catch (err) {
    document.getElementById("events-list").innerHTML =
      "<p style='color:#ff2d92;font-size:0.9rem;'>Error loading events.</p>";
  }
}

function downloadUserData(format) {
  window.location = `/api/user/export.${format}`;
}

async function openBillingPortal(licenseKey) {
  try {
    const res = await fetch("/api/billing/portal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ licenseKey }),
    });
    if (!res.ok) {
      alert("Could not open billing portal.");
      return;
    }
    const data = await res.json();
    window.location.href = data.url;
  } catch (err) {
    alert("Could not open billing portal.");
  }
}

async function logout() {
  try {
    await fetch("/api/auth/logout", { method: "POST" });
  } catch (e) {}
  window.location.href = "/login.html";
}

initPortal();
</script>

</body>
</html><div id="rinawarp-cookie-banner" class="cookie-banner">
  <div class="cookie-content">
    <p>
      We use cookies to improve your experience. 
      Read our <a href="/privacy-policy.html">Privacy Policy</a> and 
      <a href="/terms.html">Terms of Service</a>.
    </p>
    <button id="rinawarp-cookie-dismiss" class="cookie-btn">Got it!</button>
  </div>
</div>
