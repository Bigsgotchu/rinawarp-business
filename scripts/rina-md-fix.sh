#!/bin/bash
set -euo pipefail

FILE="${1:-}"

if [ -z "$FILE" ]; then
  echo "Usage: rina-md-fix <file.md>"
  exit 1
fi

if [ ! -f "$FILE" ]; then
  echo "Error: File not found: $FILE"
  exit 1
fi

echo "====================================================="
echo "          ðŸ› ï¸  RINAWARP MARKDOWN AUTO-FIX"
echo "====================================================="
echo "Fixing: $FILE"
echo ""

TMP="${FILE}.tmp"

# -------------------------------------------------------------------
# 1. Add blank lines around headings (MD022)
# -------------------------------------------------------------------
sed -E '
  s/^(#+ .*)$/\n\1\n/;
' "$FILE" > "$TMP"

# -------------------------------------------------------------------
# 2. Add blank lines around fenced code blocks (MD031)
# -------------------------------------------------------------------
sed -E '
  s/^```/\n```\n/g
' "$TMP" > "${TMP}.2"

# -------------------------------------------------------------------
# 3. Add blank lines around lists (MD032)
# -------------------------------------------------------------------
sed -E '
  s/^(\* |- [^-])/ \1/;
' "${TMP}.2" > "${TMP}.3"

# -------------------------------------------------------------------
# 4. Remove duplicate blank lines
# -------------------------------------------------------------------
sed -E '
  /^\s*$/ {
    N
    /^\s*\n\s*$/d
  }
' "${TMP}.3" > "${TMP}.4"

# -------------------------------------------------------------------
# 5. Ensure file ends with exactly one newline (MD047)
# -------------------------------------------------------------------
sed -E '$a\' "${TMP}.4" > "${TMP}.clean"

mv "${TMP}.clean" "$FILE"
rm -f "${TMP}" "${TMP}.2" "${TMP}.3" "${TMP}.4"

echo ""
echo "====================================================="
echo "    ðŸŽ‰ Markdown fixed successfully!"
echo "====================================================="